# Проект по курсу "Проектирование высоконагруженных систем".

## 1. Тема и целевая аудитория

**Twitch** – это стриминговый сервис, предназначенный для трансляции потоковых видео на игровую тематику. Сервис специализируется на играх — пользователи могут наблюдать за геймплеем, киберспортивными турнирами. Смотреть можно как онлайн, так и в записи.

### Целевая аудитория

По состоянию на август 2023 года Twitch посещает 140 миллионов уникальных пользователей каждый месяц [ \[ 1 \] ][2].

[Распределение аудитории][3]

| Страна       | Количество пользователей, млн | процент от общего количества |
| ------------ | ----------------------------- | ---------------------------- |
| США и Канада | 93                            | 36.32%                       |
| Бразилия     | 16.9                          | 6.6%                         |
| Германия     | 16.8                          | 6.56%                        |
| Англия       | 13.4                          | 5.23%                        |
| Франция      | 11.3                          | 4.41%                        |
| Россия       | 10.5                          | 4.1%                         |
| Испания      | 10.5                          | 4.1%                         |
| Аргентина    | 10                            | 3.9%                         |
| Мексика      | 9.2                           | 3.59%                        |
| Италия       | 8.3                           | 3.24%                        |
| Турция       | 7.5                           | 2.92%                        |
| Южная Корея  | 6.7                           | 2.61%                        |
| Польша       | 4.8                           | 1.87%                        |
| Япония       | 4.1                           | 1.6%                         |
| Австралия    | 4.1                           | 1.6%                         |

Большая часть аудитории приходится на Северную Америку — 39.91%. На втором месте Европа — 32.43%. На третьем месте Южная Америка — 10.5%.

### MVP

- Регистрация пользователей
- Проведение/просмотр прямых трансляций
- Просмотр закончившихся трансляций
- Подписки на пользователей
- Поиск трансляций
- Чат трансляции

## 2. Расчет нагрузки

### 2.1 Продуктовые метрики

- Месячная аудитория(MAU) — 140 млн пользователей
- Дневная аудитория(DAU) — 31 млн пользователей

Для пользователя храним следующую информацию:

- Аватар
- Никнейм
- Баннер канала
- Описание канала

Итого средний размер хранилища пользователя $\approx 4 MB$

#### Среднее количество действий пользователя по типам

- Средняя суммарная длительность всех трансляций за один день — 2 225 167 часов
- Среднее число трансляций в день — 1 167 398

Тогда средняя продолжительность трянсляции: $2225167 \div 1167398 \approx 2$ ч

По [статистике][4] пользователь тратит в день суммарно 95 минут на просмотр прямых трансляций на Twitch.
Можно предположить, что большинство пользователей не тратят все время на одну трансляцию, тогда в среднем пользовель посещает $\approx$ 3-4 трансляции в день и тратит на каждую около 30 минут.

На основе наблюдения за [количеством сообщений в секунду][5], можно сказать, что среднее количество примерно 600 сообщений. Тогда в день — $600 \times 60 \times 60 \times 24 \approx 52$ млн сообщений в день.

|                          | частота, млн/день | частота, на одного человека |
| :----------------------: | :---------------: | :-------------------------: |
|    Начало трансляции     |        1.1        |                             |
| Отправка сообщения в чат |        52         |                             |
|   Открытие трянсляции    |        2.3        |              3              |
|     Поиск трансляции     |                   |                             |
| Подписка на пользователя |                   |                             |

### 2.2 Технические метрики

#### Размер хранения в разбивке по типам данных

##### Хранилище записей трансляций

На платформе Twitch срок хранения трансляции зависит от статуса пользователя.

| Категория  | срок хранения |
| :--------- | :------------ |
| Партнеры   | 60 дней       |
| Компаньоны | 14 дней       |
| Остальные  | 7 дней        |

По [статистике](https://streamscharts.com/overview/partners) общее количество партнеров Twitch составляет **63 тыс**, а общее число компаньонов — **2.1 млн**.
Пусть каждый партнер проводит 5 трансляций в неделю (в месяц примерно 24 трансляции), как указывалось выше средняя продолжительность трансляции — 2 часа, допустим, что партнеры производят больше контента, чем обычные пользователи и их трансляции длятся в **1.5 раза** больше(3 часа), а так же они проводят трансляции в более хорошем качестве 1080 60fps, тогда на хранение трансляций партнеров за 2 месяца требуется:

$$
6000 \times 3 \times 60 \times 60 \times 63000 \times 48 \approx 22 \ \text{ПБайт}
$$

Для компаньонов возьмем те же характеристики, тогда на хранение трансляций компаньонов за 14 дней необходимо:

$$
6000 \times 3 \times 60 \times 60 \times 2.1 \times 10^{6} \times 10 \approx 155 \ \text{ПБайт}
$$

Для всех остальных(их примерно [14.5 млн](https://streamscharts.com/overview/partners) — в статистике учитывались только каналы с средним количеством зрителей 5 и более) возьмем следующие характеристики:

- Качество — 720p
- Частота кадров — 60fps
- Продолжительность трансляции $\approx$ 2 часа
- Количество трансляций в неделю — 4
  Итого: 213 ПБайт необходимо на хранение трансляций пользователй

$$
4500 \times 2 \times 60 \times 60 \times 4 \times 14.5 \times 10^{6} \approx 213 \ \text{ПБайт}
$$

| Категория пользователей | Размер хранилища, ПБайт |
| :---------------------- | :---------------------- |
| Партнеры                | 22                      |
| Компаньоны              | 155                     |
| Остальные               | 213                     |

##### Промежуточное хранилище

Чтобы сглаживать временные колебания и улучшать производительность потока для зрителей нужно буфферизировать некторый отрезок трансляции. Будем буфферизировать последние **30 секунд**
трансляции. [Самое большое число одновременных трансляций](https://twitchtracker.com/statistics/channels) составляет 233 935. Рассчитаем размер промежуточного хранилища, считая что трансляции ведутся в 720p 60fps с битрейтом 4500kbps.

$$
4500 \times 30 \times 234\ 000 \approx 4 \ ТБайт
$$

Получаем размер промежуточного хранилища: **4 ТБайт**

#### Сетевой трафик

##### Входящий трафик

Как уже указывалось выше, средняя суммарная длительность всех трансляций за один день — 2 225 167 часов. Для видео в качестве 720p и частотой обновления обновления 60 fps, платформа Twitch [рекомендует][6] выставлять битрейт 4500 kbps.
Поэтому входящая нагрузка составляет:

$$
4500 \times2\ 225\ 168  \times 60 \times 60 \approx 3.6 \times 10^{13} \ \text{кбит в сутки} \approx 4 \ 250 \ 000 \ \text{ГБайт в сутки}
$$

Из [данных](https://twitchtracker.com/statistics/channels) следует, что самое большое количество одновременно активных трансляций в течении дня составляет примерно 130 000, тогда пиковая нагрузка составляет:

$$
130\ 000 \times 4500 \approx 557 ~ \text{Гбит в секунду}
$$

Средняя нагрузка:

$$
93\ 000 \times 4500 \approx 399 \ \text{Гбит/сек}
$$

Суточное количество сообщений в чат составляет $\approx$ 52 млн сообщений.
Допустим, символы кодируются в UTF-8, тогда на каждый символ приходится от 1 до 4 байт, возьмем средний размер — 2 байта. Пусть средняя длина сообщения составляет 20 символов, тогда нагрузка рассчитывается следующим образом:

$$
52 \times 10^{6}\times 16 \times 20 \approx 12\ \text{Гбит в день}
$$

Средняя нагрузка:

$$
600 \times 16 \times 20 \approx 0.002 \
 \text{Гбит/сек}
$$

Для рассчета пиковой нагрузки, умножим среднюю нагрузку на отношение пикового количества зрителей к среднему.

$$
	600 \times \frac{4\ 000\ 000}{2\ 337\ 099} \times 16 \times 20 \approx 0.0034 \ \text{Гбит/сек}
$$

| Тип запроса              | средняя нагрузка ГБит/сек | пиковая нагрузка, Гбит/сек | Суточная нагрузка, ГБайт/сутки |
| :----------------------- | :------------------------ | :------------------------- | :----------------------------- |
| Проведение трансляции    | 399                       | 557                        | 4 250 000                      |
| Отправка сообщений в чат | 0.002                     | 0.0034                     | 12                             |

##### Исходящий трафик

По [данным](https://twitchtracker.com/statistics/viewers) на август 2023 года среднее количество зрителей, которые одновременно смотрят трансляции, составляет 2 401 236. На основе этого цифры можно вычислить среднюю сетевую наргрузку:

$$
 4500 \ \times \  2\ 401\ 236 \approx 10 \ \text{Тбит/сек}
$$

Исходя из данных того же источника, абсолютный максимум зрителей составляет 6 647 412. Если же говорить про дневную пиковую нагрузку, то это нагрузка, которая приходится на 22:00 — 23:00 и варьируется между 3,5 млн и 4 млн. Возьмем для расчетов пиковой нагрузки верхную границу.

$$
4500 \times 4\ 000 \ 000 \ = 24 \times 10^{9} \approx 17 \ \text{Тбит/сек}
$$

[Суммарное время просмотра за день](https://twitchtracker.com/statistics/watch-time) составляет 56 186 956 часов. Тогда дневная нагрузка составляет:

$$
56 186 956 \times 60 \times 60 \times 4500 \approx 105965 \ \text{ТБайт/сутки}
$$

Рассчитаем среднее число зрителей на трансляцию

$$
\frac{2\ 401\ 236}{93000} \approx 26\ \text{чел. на трансляцию}
$$

Тогда если один человек отправляет сообщение в чат, его нужно доставить остальным зрителям, поэтому трафик для чтения чата рассчитывается следующи образом:

- Средняя нагрузка — $26 \times 0.002 = 0.05\ \text{Гбит/сек}$
- Дневная нагрузка — $12 \times 26 = 312\ \text{ГБайт/Сутки}$
- Пиковая нагрузка — $\frac{4\ 000\ 000}{130\ 000} \times 0.0034 \approx 0.1 \ \text{Гбит/с}$

|     Тип запроса     | Средняя нагрузка, Гбит/с | Пиковая нагрузка, Гбит/с | Дневная нагрузка, ГБайт/сутки |
| :-----------------: | :----------------------: | :----------------------: | :---------------------------: |
| Просмотр трансляции |       10 Тбит/сек        |       17 ТБит/сек        |      105965 ТБайт/сутки       |
|     Чтение чата     |           0.05           |           0.1            |              312              |

#### RPS в разбивке по типам запросов

| Тип запроса         | RPS |
| :------------------ | :-- |
| Просмотр трансляции |     |
| Отправка сообщения  |     |

## Источники

1. https://twitchtracker.com/statistics
2. https://www.demandsage.com/twitch-users/
3. https://worldpopulationreview.com/country-rankings/twitch-users-by-country
4. https://www.enterpriseappstoday.com/stats/twitch-statistics.html
5. https://stats.streamelements.com/
6. https://help.twitch.tv/s/article/broadcasting-guidelines?language=en_US
7. https://twitchstats.net/
8. https://streamscharts.com/

[1]: https://twitchtracker.com/statistics
[2]: https://www.demandsage.com/twitch-users/
[3]: https://worldpopulationreview.com/country-rankings/twitch-users-by-country
[4]: https://www.enterpriseappstoday.com/stats/twitch-statistics.html
[5]: https://stats.streamelements.com/
[6]: https://help.twitch.tv/s/article/broadcasting-guidelines?language=en_US
[7]: https://twitchstats.net/
[8]: https://streamscharts.com/
